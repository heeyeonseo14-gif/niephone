<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<title>niephone</title>

<style>
body {
    margin: 0;
    background: #f5f5f5;
    font-family: Arial, sans-serif;
    display: flex;
    justify-content: center;
    padding-top: 20px;
}

.phone {
    width: 380px;
    height: 700px;
    background: white;
    border-radius: 25px;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.header {
    background: #07c160;
    padding: 12px;
    font-size: 20px;
    color: white;
    position: relative;
    text-align: center;
}

.settings-btn {
    position: absolute;
    right: 15px;
    top: 12px;
    color: white;
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
}

.chat-box {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
    background-size: cover;
    background-position: center;
}

.msg-row {
    display: flex;
    align-items: flex-end;
    margin: 10px 0;
}

.msg {
    max-width: 70%;
    padding: 10px 14px;
    border-radius: 12px;
    margin: 5px;
    word-break: break-word;
}

.me {
    background: #95ec69;
    margin-left: auto;
}

.ai {
    background: #e5e5e5;
    margin-right: auto;
}

/* 头像 */
.avatar-ai,
.avatar-me {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    object-fit: cover;
}

.avatar-ai { margin-right: 8px; }
.avatar-me { margin-left: 8px; }

/* 输入区 */
.input-area {
    display: flex;
    padding: 10px;
    border-top: 1px solid #ddd;
}

input {
    flex: 1;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #ccc;
}

button {
    margin-left: 10px;
    padding: 10px 15px;
    border: none;
    background: #07c160;
    color: white;
    border-radius: 10px;
    cursor: pointer;
}

/* 设置面板 */
.settings-panel {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 999;
}

.panel-box {
    background: white;
    width: 80%;
    padding: 20px;
    border-radius: 15px;
}

.panel-box input,
.panel-box select {
    width: 100%;
    margin: 10px 0;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #ccc;
}
</style>
</head>

<body>
<div class="phone">
    <div class="header">
        niephone
        <button class="settings-btn" onclick="openSettings()">⚙</button>
    </div>

    <!-- 设置面板 -->
    <div class="settings-panel" id="settingsPanel">
        <div class="panel-box">
            <h3>API 设置</h3>

            <label>API 地址：</label>
            <input id="apiUrl" placeholder="例如：https://api.openai.com/v1" />

            <label>API Key：</label>
            <input id="apiKey" placeholder="你的 API Key" />

            <label>选择模型：</label>
            <select id="modelSelect">
                <option>请填写 API 后加载</option>
            </select>

            <hr>

            <h3>外观设置</h3>

            <label>更换聊天背景（壁纸）</label>
            <input type="file" accept="image/*" onchange="setWallpaper(event)" />

            <label>用户头像（我）</label>
            <input type="file" accept="image/*" onchange="setAvatarMe(event)" />

            <label>AI 头像</label>
            <input type="file" accept="image/*" onchange="setAvatarAi(event)" />

            <br>

            <button onclick="saveSettings()">保存</button>
            <button style="margin-left:10px;background:#999;" onclick="closeSettings()">关闭</button>
        </div>
    </div>

    <!-- 聊天内容 -->
    <div class="chat-box" id="chat"></div>

    <!-- 输入区 -->
    <div class="input-area">
        <input id="msgInput" placeholder="输入消息…" />
        <button onclick="sendMsg()">发送</button>
    </div>

</div> <!-- phone 结束 -->

<script>
    // 从 localStorage 读取已保存内容
let apiKey = localStorage.getItem("nie_api_key") || "";
let apiUrl = localStorage.getItem("nie_api_url") || "";
let modelName = localStorage.getItem("nie_model") || "";
let wallpaper = localStorage.getItem("nie_wallpaper") || "";
let avatarMe = localStorage.getItem("nie_avatar_me") || "";
let avatarAi = localStorage.getItem("nie_avatar_ai") || "";

// 页面加载后应用壁纸
window.onload = function() {
    if (wallpaper) {
        let chat = document.getElementById("chat");
        chat.style.backgroundImage = `url(${wallpaper})`;
    }
};

// 打开设置面板
function openSettings() {
    document.getElementById("settingsPanel").style.display = "flex";

    document.getElementById("apiKey").value = apiKey;
    document.getElementById("apiUrl").value = apiUrl;

    if (apiKey && apiUrl) loadModels();
}

// 关闭设置
function closeSettings() {
    document.getElementById("settingsPanel").style.display = "none";
}

// 保存 API 信息
function saveSettings() {
    apiKey = document.getElementById("apiKey").value.trim();
    apiUrl = document.getElementById("apiUrl").value.trim();
    let sel = document.getElementById("modelSelect");
    modelName = sel.value;

    if (!apiKey || !apiUrl) {
        alert("API 地址与 Key 不能为空！");
        return;
    }

    localStorage.setItem("nie_api_key", apiKey);
    localStorage.setItem("nie_api_url", apiUrl);
    localStorage.setItem("nie_model", modelName);

    alert("保存成功！");
    closeSettings();
}

// 读取模型列表
async function loadModels() {
    let modelSelect = document.getElementById("modelSelect");
    modelSelect.innerHTML = "<option>加载中...</option>";

    try {
        let url = apiUrl.replace(/\/$/, "") + "/models";
        let res = await fetch(url, {
            headers: { "Authorization": `Bearer ${apiKey}` }
        });

        let data = await res.json();

        modelSelect.innerHTML = "";
        let models = data.data || data.models || [];

        models.forEach(m => {
            let op = document.createElement("option");
            op.value = m.id || m.name;
            op.textContent = m.id || m.name;
            modelSelect.appendChild(op);
        });

        if (modelName) modelSelect.value = modelName;

    } catch (err) {
        modelSelect.innerHTML = "<option>加载模型失败</option>";
        console.error(err);
    }
}
async function sendMsg() {
    let text = document.getElementById("msgInput").value;
    if (!text) return;

    let chat = document.getElementById("chat");

    // 用户消息
    let rowMe = document.createElement("div");
    rowMe.className = "msg-row";
    rowMe.style.justifyContent = "flex-end";

    let meBubble = document.createElement("div");
    meBubble.className = "msg me";
    meBubble.innerText = text;

    let imgMe = document.createElement("img");
    imgMe.className = "avatar-me";
    imgMe.src = localStorage.getItem("nie_avatar_me") ||
                "https://i.imgur.com/4ZQZ4fP.png";

    rowMe.appendChild(meBubble);
    rowMe.appendChild(imgMe);
    chat.appendChild(rowMe);

    document.getElementById("msgInput").value = "";
    chat.scrollTop = chat.scrollHeight;

    // 没设置 API 时提示
    if (!apiKey || !apiUrl || !modelName) {
        let warn = document.createElement("div");
        warn.className = "msg ai";
        warn.innerText = "⚠ 请先进入设置配置 API";
        chat.appendChild(warn);
        chat.scrollTop = chat.scrollHeight;
        return;
    }

    // AI 正在思考
    let rowAi = document.createElement("div");
    rowAi.className = "msg-row";

    let imgAi = document.createElement("img");
    imgAi.className = "avatar-ai";
    imgAi.src = localStorage.getItem("nie_avatar_ai") ||
                "https://i.imgur.com/Z7AzH2z.png";

    let aiBubble = document.createElement("div");
    aiBubble.className = "msg ai";
    aiBubble.innerText = "……";

    rowAi.appendChild(imgAi);
    rowAi.appendChild(aiBubble);
    chat.appendChild(rowAi);
    chat.scrollTop = chat.scrollHeight;

    try {
        // 自动拼接 /v1/chat/completions 接口
        let chatUrl = apiUrl.replace(/\/$/, "");
        if (!chatUrl.includes("/chat/completions")) {
            chatUrl += "/v1/chat/completions";
        }

        let res = await fetch(chatUrl, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${apiKey}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                model: modelName,
                messages: [{ role: "user", content: text }]
            })
        });

        let data = await res.json();
        let reply = data.choices?.[0]?.message?.content || "(AI 无回复)";
        aiBubble.innerText = reply;

    } catch (err) {
        aiBubble.innerText = "⚠ AI 调用失败";
        console.error(err);
    }

    chat.scrollTop = chat.scrollHeight;
}
/*********** 外观：设置壁纸 ***********/
function setWallpaper(event) {
    let file = event.target.files[0];
    if (!file) return;

    let reader = new FileReader();
    reader.onload = function(e) {
        let url = e.target.result;

        let chat = document.getElementById("chat");
        chat.style.backgroundImage = `url(${url})`;
        chat.style.backgroundSize = "cover";
        chat.style.backgroundPosition = "center";

        localStorage.setItem("nie_wallpaper", url);
        wallpaper = url;
    };
    reader.readAsDataURL(file);
}


/*********** 外观：用户头像 ***********/
function setAvatarMe(event) {
    let file = event.target.files[0];
    if (!file) return;

    let reader = new FileReader();
    reader.onload = function(e) {
        let url = e.target.result;

        localStorage.setItem("nie_avatar_me", url);
        avatarMe = url;

        alert("用户头像已更新！");
    };
    reader.readAsDataURL(file);
}


/*********** 外观：AI 头像 ***********/
function setAvatarAi(event) {
    let file = event.target.files[0];
    if (!file) return;

    let reader = new FileReader();
    reader.onload = function(e) {
        let url = e.target.result;

        localStorage.setItem("nie_avatar_ai", url);
        avatarAi = url;

        alert("AI 头像已更新！");
    };
    reader.readAsDataURL(file);
}
</script>

</body>
</html> 
