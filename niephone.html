<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<title>niephone</title>

<style>
body {
    margin:0;
    background:#f5f5f5;
    font-family:Arial;
    display:flex;
    justify-content:center;
    padding-top:20px;
}

.phone {
    width:380px;
    height:700px;
    background:white;
    border-radius:25px;
    box-shadow:0 0 15px rgba(0,0,0,0.2);
    display:flex;
    flex-direction:column;
    overflow:hidden;
}

.header {
    background:#07c160;
    padding:12px;
    font-size:20px;
    color:white;
    position:relative;
    text-align:center;
}

.settings-btn {
    position:absolute;
    right:15px;
    top:12px;
    color:white;
    background:none;
    border:none;
    font-size:16px;
}

.chat-box {
    flex:1;
    padding:10px;
    overflow-y:auto;
}

.msg {
    max-width:75%;
    padding:10px 14px;
    border-radius:12px;
    margin:8px 0;
    word-break:break-word;
}

.me {
    background:#95ec69;
    margin-left:auto;
}

.ai {
    background:#e5e5e5;
    margin-right:auto;
}

.input-area {
    display:flex;
    padding:10px;
    border-top:1px solid #ddd;
}

input {
    flex:1;
    padding:10px;
    border-radius:10px;
    border:1px solid #ccc;
}

button {
    margin-left:10px;
    padding:10px 15px;
    border:none;
    background:#07c160;
    color:white;
    border-radius:10px;
}

.settings-panel {
    position:absolute;
    top:0; left:0; right:0; bottom:0;
    background:rgba(0,0,0,0.5);
    display:none;
    justify-content:center;
    align-items:center;
}

.panel-box {
    background:white;
    width:80%;
    padding:20px;
    border-radius:15px;
}

.panel-box input, .panel-box select {
    width:100%;
    margin:10px 0;
    padding:10px;
    border-radius:10px;
    border:1px solid #ccc;
}
</style>
</head>

<body>
    <div class="phone">

    <div class="header">
        niephone
        <button class="settings-btn" onclick="openSettings()">⚙</button>
    </div>

    <!-- 设置面板 -->
    <div class="settings-panel" id="settingsPanel">
        <div class="panel-box">
            <h3>API 设置</h3>

            <input id="apiUrl" placeholder="API 地址，如 https://api521.pro/v1" />
            <input id="apiKey" placeholder="API Key" />

            <label>选择模型：</label>
            <select id="modelSelect">
                <option>加载中…</option>
            </select>

            <button onclick="saveSettings()">保存</button>
            <button style="margin-left:10px;background:#999;" onclick="closeSettings()">关闭</button>
        </div>
    </div>

    <!-- 聊天内容 -->
    <div class="chat-box" id="chat"></div>

    <!-- 输入区 -->
    <div class="input-area">
        <input id="msgInput" placeholder="输入消息…" />
        <button onclick="sendMsg()">发送</button>
    </div>

</div>

<script>
let apiKey = localStorage.getItem("nie_api_key") || "";
let apiUrl = localStorage.getItem("nie_api_url") || "";
let modelName = localStorage.getItem("nie_model") || "";
    // 打开设置面板
function openSettings() {
  document.getElementById("settingsPanel").style.display = "flex";
  document.getElementById("apiKey").value = apiKey || "";
  // 如果你想强制显示固定的基础地址（只呈现 https://api521.pro/v1），可以把下一行改为固定值：
  // document.getElementById("apiUrl").value = "https://api521.pro/v1";
  document.getElementById("apiUrl").value = apiUrl || "";
  // 如果之前有保存的模型名则设置下拉选中（可能为空）
  if (modelName) {
    // 等待 loadModels 完成会自动选中
  }
  // 如果填写了 API 信息，自动拉取模型列表
  if (apiKey && apiUrl) {
    loadModels();
  }
}

// 关闭设置面板
function closeSettings() {
  document.getElementById("settingsPanel").style.display = "none";
}

// 保存设置（写 localStorage）
function saveSettings() {
  let inKey = document.getElementById("apiKey").value.trim();
  let inUrl = document.getElementById("apiUrl").value.trim();
  let sel = document.getElementById("modelSelect");
  let inModel = sel ? (sel.value || "") : "";

  // 如果你强制想要 apiUrl 一直是 https://api521.pro/v1，可以在这里覆盖：
  // inUrl = "https://api521.pro/v1";

  if (!inKey || !inUrl) {
    alert("请填写 API URL 和 API Key");
    return;
  }

  apiKey = inKey;
  apiUrl = inUrl;
  modelName = inModel;

  localStorage.setItem("nie_api_key", apiKey);
  localStorage.setItem("nie_api_url", apiUrl);
  localStorage.setItem("nie_model", modelName);

  alert("保存成功！");
  closeSettings();
  // 保存后尝试加载模型（如果需要）
  if (apiKey && apiUrl) loadModels();
}

// 从 API 加载模型列表（兼容多种返回格式）
async function loadModels() {
  let modelSelect = document.getElementById("modelSelect");
  if (!modelSelect) return;
  modelSelect.innerHTML = "<option>加载中…</option>";

  try {
    // 将用户输入的基础地址拼接成 /v1/models（兼容用户填 /v1 或 /v1/ 或直接 /models）
    let modelsUrl = apiUrl || "";
    // 强制去掉末尾斜杠
    modelsUrl = modelsUrl.replace(/\/+$/, "");
    // 如果用户直接输入了 /models 或 /v1/models 就不重复添加
    if (!modelsUrl.endsWith("/models")) {
      // 如果用户只填了 /v1，则加 /models；如果填的是根域名也加 /v1/models 视情况而定
      // 这里用比较保守的策略：优先尝试 /models（适配很多代理），如果接口要求 /v1/models，请把 apiUrl 改为包含 /v1
      modelsUrl = modelsUrl + "/models";
    }

    const res = await fetch(modelsUrl, {
      headers: {
        "Authorization": `Bearer ${apiKey}`
      }
    });
    const data = await res.json();

    // 清空
    modelSelect.innerHTML = "";

    // 兼容不同格式：data.data / data.models / data.model / data
    let list = data.data || data.models || data.model || data;

    // 如果返回是对象且里面有 models 字段再取一次
    if (!Array.isArray(list) && typeof list === "object") {
      // 可能像 {models: [...]}
      list = list.models || list.list || Object.values(list);
    }

    if (!Array.isArray(list) || list.length === 0) {
      // 没拿到列表，尝试用另一种常见字段（兼容某些代理）
      modelSelect.innerHTML = "<option>无法读取模型列表</option>";
      return;
    }

    list.forEach(m => {
      // 有些返回项直接是字符串，有些是对象
      let name = "";
      if (typeof m === "string") name = m;
      else name = m.id || m.model || m.name || (m.modelId || "");
      if (name) {
        let op = document.createElement("option");
        op.value = name;
        op.textContent = name;
        modelSelect.appendChild(op);
      }
    });

    // 如果之前保存过 modelName，试着选中
    if (modelName) {
      try { modelSelect.value = modelName; } catch(e) {}
    }
  } catch (err) {
    modelSelect.innerHTML = "<option>加载模型失败</option>";
    console.error("loadModels error:", err);
  }
}
    // 发送消息到 API（新版，支持 /v1/chat/completions）
async function sendMsg() {
    let text = document.getElementById("msgInput").value.trim();
    if (!text) return;

    let chat = document.getElementById("chat");

    // 显示自己的消息
    let userMsg = document.createElement("div");
    userMsg.className = "msg me";
    userMsg.innerText = text;
    chat.appendChild(userMsg);

    document.getElementById("msgInput").value = "";
    chat.scrollTop = chat.scrollHeight;

    // 检查 API 配置
    if (!apiKey || !apiUrl || !modelName) {
        let warn = document.createElement("div");
        warn.className = "msg ai";
        warn.innerText = "请先进入设置填写 API URL、API Key 和模型。";
        chat.appendChild(warn);
        chat.scrollTop = chat.scrollHeight;
        return;
    }

    // AI 正在思考…
    let aiMsg = document.createElement("div");
    aiMsg.className = "msg ai";
    aiMsg.innerText = "正在思考…";
    chat.appendChild(aiMsg);
    chat.scrollTop = chat.scrollHeight;

    try {
        // 自动补全聊天接口（API521 标准：/v1/chat/completions）
        let chatUrl = apiUrl.replace(/\/+$/, ""); // 去掉末尾 /
        if (!chatUrl.endsWith("/chat/completions")) {
            chatUrl += "/chat/completions";
        }

        const res = await fetch(chatUrl, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: modelName,
                messages: [
                    { role: "user", content: text }
                ]
            })
        });

        const data = await res.json();
        console.log("AI 返回：", data);

        let reply = "";

        // 兼容各种返回格式 ↓↓↓
        if (data.choices && data.choices[0]?.message?.content) {
            reply = data.choices[0].message.content;
        }
        else if (data.output_text) {
            reply = data.output_text;
        }
        else if (data.reply) {
            reply = data.reply;
        }
        else {
            reply = JSON.stringify(data, null, 2);
        }

        aiMsg.innerText = reply;

    } catch (err) {
        console.error("sendMsg error:", err);
        aiMsg.innerText = "⚠ AI 调用失败，请检查 API 设置。";
    }

    chat.scrollTop = chat.scrollHeight;
}
</script>
</body>
</html>
