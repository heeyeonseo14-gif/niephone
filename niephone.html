<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<title>niephone</title>

<style>
body {
    margin:0;
    background:#e9eef3;
    font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
    display:flex;
    justify-content:center;
    padding-top:25px;
}

/* 手机壳 */
.phone {
    width:390px;
    height:780px;
    background:white;
    border-radius:32px;
    box-shadow:0 10px 35px rgba(0,0,0,0.15);
    display:flex;
    flex-direction:column;
    overflow:hidden;
    position:relative;
}

/* 顶部状态栏 */
.status-bar {
    height:20px;
    background:white;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 12px;
    font-size:12px;
    color:#555;
}

/* 顶部标题栏 */
.header {
    background:#07c160;
    padding:14px;
    font-size:22px;
    color:white;
    position:relative;
    text-align:center;
    letter-spacing:1px;
}

.settings-btn {
    position:absolute;
    right:16px;
    top:14px;
    color:white;
    background:none;
    border:none;
    font-size:20px;
}

/* 聊天框 */
.chat-box {
    flex:1;
    padding:14px;
    overflow-y:auto;
    background:#f6f6f6;
}

/* 气泡基础 */
.msg {
    max-width:75%;
    padding:12px 16px;
    border-radius:16px;
    margin:10px 0;
    word-break:break-word;
    font-size:16px;
    line-height:1.5;
    box-shadow:0px 2px 6px rgba(0,0,0,0.1);
}

/* 我的消息 */
.msg.me {
    background:#9fe8a9;
    margin-left:auto;
    border-bottom-right-radius:4px;
}

/* AI 消息 */
.msg.ai {
    background:white;
    margin-right:auto;
    border-bottom-left-radius:4px;
}

/* 输入区域 */
.input-area {
    display:flex;
    padding:12px;
    background:white;
    border-top:1px solid #ddd;
}

#msgInput {
    flex:1;
    padding:12px 15px;
    border-radius:25px;
    border:1px solid #ccc;
    font-size:16px;
}

/* 发送按钮 */
.send-btn {
    margin-left:10px;
    width:48px;
    height:48px;
    border-radius:24px;
    border:none;
    background:#07c160;
    color:white;
    font-size:18px;
    font-weight:bold;
}

/* 设置面板 */
.settings-panel {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    display: none;           /* 默认隐藏 */
    justify-content: center;
    align-items: center;
    z-index: 1000;           /* 确保在最上层显示时在顶层 */
    pointer-events: auto;    /* 允许点击（隐藏时 display:none 就不会拦截） */
}

.panel-box {
    background:white;
    width:78%;
    padding:22px;
    border-radius:18px;
    box-shadow:0 8px 25px rgba(0,0,0,0.2);
}

.panel-box input, .panel-box select {
    width:100%;
    margin:12px 0;
    padding:12px;
    border-radius:12px;
    border:1px solid #ccc;
    font-size:15px;
}
    
/* 聊天背景支持壁纸 */
.chat-box {
    background-size: cover;
    background-position: center;
}

/* 气泡加头像布局容器 */
.msg-row {
    display: flex;
    align-items: flex-end;
    margin: 10px 0;
}

/* 左侧 AI 头像 */
.avatar-ai {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    margin-right: 8px;
    object-fit: cover;
}

/* 右侧用户头像 */
.avatar-me {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    margin-left: 8px;
    object-fit: cover;
}

.msg.me {
    margin-left: 0;
}

.msg.ai {
    margin-right: 0;
}
</style>
</head>

<body>
    <div class="phone">

    <div class="header">
        niephone
        <button class="settings-btn" onclick="openSettings()">⚙</button>
    </div>

    <!-- 设置面板 -->
    <div class="settings-panel" id="settingsPanel">
        <div class="panel-box">
            <h3 style="margin-top:0;">API 设置</h3>

            <input id="apiUrl" placeholder="API 地址，如 https://api521.pro/v1" />
            <input id="apiKey" placeholder="API Key" />

            <label>选择模型：</label>
            <select id="modelSelect">
                <option>加载中…</option>
            </select>
<label>更换聊天背景（壁纸）</label>
<input type="file" accept="image/*" onchange="setWallpaper(event)" />

<label>用户头像：</label>
<input type="file" accept="image/*" onchange="setAvatarMe(event)" />

<label>AI 头像：</label>
<input type="file" accept="image/*" onchange="setAvatarAi(event)" />
            <button onclick="saveSettings()" style="width:100%;background:#4CC38A;color:white;padding:12px;border-radius:14px;border:none;">
                保存
            </button>
            <button onclick="closeSettings()" style="width:100%;margin-top:10px;background:#ccc;color:white;padding:12px;border-radius:14px;border:none;">
                关闭
            </button>
        </div>
    </div>

    <!-- 聊天内容 -->
    <div class="chat-box" id="chat"></div>

    <!-- 输入区 -->
    <div class="input-area">
        <input id="msgInput" placeholder="输入消息…" />
        <button class="send-btn" onclick="sendMsg()">发送</button>
    </div>

    </div>
<script>
let apiKey = localStorage.getItem("nie_api_key") || "";
let apiUrl = localStorage.getItem("nie_api_url") || "";
let modelName = localStorage.getItem("nie_model") || "";
    // 打开设置面板
function openSettings() {
  document.getElementById("settingsPanel").style.display = "flex";
  document.getElementById("apiKey").value = apiKey || "";
  // 如果你想强制显示固定的基础地址（只呈现 https://api521.pro/v1），可以把下一行改为固定值：
  // document.getElementById("apiUrl").value = "https://api521.pro/v1";
  document.getElementById("apiUrl").value = apiUrl || "";
  // 如果之前有保存的模型名则设置下拉选中（可能为空）
  if (modelName) {
    // 等待 loadModels 完成会自动选中
  }
  // 如果填写了 API 信息，自动拉取模型列表
  if (apiKey && apiUrl) {
    loadModels();
  }
}

// 关闭设置面板
function closeSettings() {
  document.getElementById("settingsPanel").style.display = "none";
}

// 保存设置（写 localStorage）
function saveSettings() {
  let inKey = document.getElementById("apiKey").value.trim();
  let inUrl = document.getElementById("apiUrl").value.trim();
  let sel = document.getElementById("modelSelect");
  let inModel = sel ? (sel.value || "") : "";

  // 如果你强制想要 apiUrl 一直是 https://api521.pro/v1，可以在这里覆盖：
  // inUrl = "https://api521.pro/v1";

  if (!inKey || !inUrl) {
    alert("请填写 API URL 和 API Key");
    return;
  }

  apiKey = inKey;
  apiUrl = inUrl;
  modelName = inModel;

  localStorage.setItem("nie_api_key", apiKey);
  localStorage.setItem("nie_api_url", apiUrl);
  localStorage.setItem("nie_model", modelName);

  alert("保存成功！");
  closeSettings();
  // 保存后尝试加载模型（如果需要）
  if (apiKey && apiUrl) loadModels();
}

// 从 API 加载模型列表（兼容多种返回格式）
async function loadModels() {
  let modelSelect = document.getElementById("modelSelect");
  if (!modelSelect) return;
  modelSelect.innerHTML = "<option>加载中…</option>";

  try {
    // 将用户输入的基础地址拼接成 /v1/models（兼容用户填 /v1 或 /v1/ 或直接 /models）
    let modelsUrl = apiUrl || "";
    // 强制去掉末尾斜杠
    modelsUrl = modelsUrl.replace(/\/+$/, "");
    // 如果用户直接输入了 /models 或 /v1/models 就不重复添加
    if (!modelsUrl.endsWith("/models")) {
      // 如果用户只填了 /v1，则加 /models；如果填的是根域名也加 /v1/models 视情况而定
      // 这里用比较保守的策略：优先尝试 /models（适配很多代理），如果接口要求 /v1/models，请把 apiUrl 改为包含 /v1
      modelsUrl = modelsUrl + "/models";
    }

    const res = await fetch(modelsUrl, {
      headers: {
        "Authorization": `Bearer ${apiKey}`
      }
    });
    const data = await res.json();

    // 清空
    modelSelect.innerHTML = "";

    // 兼容不同格式：data.data / data.models / data.model / data
    let list = data.data || data.models || data.model || data;

    // 如果返回是对象且里面有 models 字段再取一次
    if (!Array.isArray(list) && typeof list === "object") {
      // 可能像 {models: [...]}
      list = list.models || list.list || Object.values(list);
    }

    if (!Array.isArray(list) || list.length === 0) {
      // 没拿到列表，尝试用另一种常见字段（兼容某些代理）
      modelSelect.innerHTML = "<option>无法读取模型列表</option>";
      return;
    }

    list.forEach(m => {
      // 有些返回项直接是字符串，有些是对象
      let name = "";
      if (typeof m === "string") name = m;
      else name = m.id || m.model || m.name || (m.modelId || "");
      if (name) {
        let op = document.createElement("option");
        op.value = name;
        op.textContent = name;
        modelSelect.appendChild(op);
      }
    });

    // 如果之前保存过 modelName，试着选中
    if (modelName) {
      try { modelSelect.value = modelName; } catch(e) {}
    }
  } catch (err) {
    modelSelect.innerHTML = "<option>加载模型失败</option>";
    console.error("loadModels error:", err);
  }
}
    // 发送消息到 API（新版，支持 /v1/chat/completions）
async function sendMsg() {
    let text = document.getElementById("msgInput").value.trim();
    if (!text) return;

    let chat = document.getElementById("chat");

    // 显示自己的消息
    let userMsg = document.createElement("div");
    userMsg.className = "msg me";
    userMsg.innerText = text;
    chat.appendChild(userMsg);

    document.getElementById("msgInput").value = "";
    chat.scrollTop = chat.scrollHeight;

    // 检查 API 配置
    if (!apiKey || !apiUrl || !modelName) {
        let warn = document.createElement("div");
        warn.className = "msg ai";
        warn.innerText = "请先进入设置填写 API URL、API Key 和模型。";
        chat.appendChild(warn);
        chat.scrollTop = chat.scrollHeight;
        return;
    }

    // AI 正在思考…
    let aiMsg = document.createElement("div");
    aiMsg.className = "msg ai";
    aiMsg.innerText = "正在思考…";
    chat.appendChild(aiMsg);
    chat.scrollTop = chat.scrollHeight;

    try {
        // 自动补全聊天接口（API521 标准：/v1/chat/completions）
        let chatUrl = apiUrl.replace(/\/+$/, ""); // 去掉末尾 /
        if (!chatUrl.endsWith("/chat/completions")) {
            chatUrl += "/chat/completions";
        }

        const res = await fetch(chatUrl, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: modelName,
                messages: [
                    { role: "user", content: text }
                ]
            })
        });

        const data = await res.json();
        console.log("AI 返回：", data);

        let reply = "";

        // 兼容各种返回格式 ↓↓↓
        if (data.choices && data.choices[0]?.message?.content) {
            reply = data.choices[0].message.content;
        }
        else if (data.output_text) {
            reply = data.output_text;
        }
        else if (data.reply) {
// 发送消息到 API
async function sendMsg() {
    let text = document.getElementById("msgInput").value.trim();
    if (!text) return;

    let chat = document.getElementById("chat");

    // 读取用户头像（如果无，使用默认）
    let avatarMe = localStorage.getItem("nie_avatar_me") || "";

    // 显示用户消息 + 头像
    let rowMe = document.createElement("div");
    rowMe.className = "msg-row";
    rowMe.style.justifyContent = "flex-end";

    let meBubble = document.createElement("div");
    meBubble.className = "msg me";
    meBubble.innerText = text;

    let imgMe = document.createElement("img");
    imgMe.className = "avatar-me";
    imgMe.src = avatarMe || "https://i.imgur.com/WxZS2sO.png";

    rowMe.appendChild(meBubble);
    rowMe.appendChild(imgMe);
    chat.appendChild(rowMe);

    document.getElementById("msgInput").value = "";
    chat.scrollTop = chat.scrollHeight;

    // 没有配置 API
    if (!apiKey || !apiUrl || !modelName) {
        let warn = document.createElement("div");
        warn.className = "msg ai";
        warn.innerText = "⚠ 请先进入设置填写 API 信息";
        chat.appendChild(warn);
        return;
    }

    // AI 正在思考提示
    let rowAi = document.createElement("div");
    rowAi.className = "msg-row";

    let imgAi = document.createElement("img");
    imgAi.className = "avatar-ai";
    imgAi.src = localStorage.getItem("nie_avatar_ai") || "https://i.imgur.com/7yUvePI.png";

    let aiBubble = document.createElement("div");
    aiBubble.className = "msg ai";
    aiBubble.innerText = "……";

    rowAi.appendChild(imgAi);
    rowAi.appendChild(aiBubble);
    chat.appendChild(rowAi);
    chat.scrollTop = chat.scrollHeight;

    try {
        // 自动拼接 chat 接口
        let chatUrl = apiUrl.replace(/\/$/, "");
        if (!chatUrl.endsWith("/v1/chat/completions")) {
            chatUrl += "/v1/chat/completions";
        }

        let res = await fetch(chatUrl, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${apiKey}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                model: modelName,
                messages: [
                    { role: "user", content: text }
                ]
            })
        });

        let data = await res.json();
        let reply = data.choices?.[0]?.message?.content || "（AI 未返回内容）";

        aiBubble.innerText = reply;
        chat.scrollTop = chat.scrollHeight;

    } catch (err) {
        aiBubble.innerText = "⚠ AI 调用失败";
        console.error(err);
    }
                                       }
    // 设置聊天背景（壁纸）
function setWallpaper(event) {
    let file = event.target.files[0];
    if (!file) return;

    let reader = new FileReader();
    reader.onload = function (e) {
        let url = e.target.result;

        // 设置聊天区背景
        let chat = document.getElementById("chat");
        chat.style.backgroundImage = `url(${url})`;
        chat.style.backgroundSize = "cover";
        chat.style.backgroundPosition = "center";

        // 写入 localStorage
        localStorage.setItem("nie_wallpaper", url);

        alert("壁纸已更新！");
    };
    reader.readAsDataURL(file);
}


// 设置用户头像（我）
function setAvatarMe(event) {
    let file = event.target.files[0];
    if (!file) return;

    let reader = new FileReader();
    reader.onload = function (e) {
        let url = e.target.result;

        // 保存到 localStorage
        localStorage.setItem("nie_avatar_me", url);

        alert("用户头像已更新！");
    };
    reader.readAsDataURL(file);
}


// 设置 AI 头像
function setAvatarAi(event) {
    let file = event.target.files[0];
    if (!file) return;

    let reader = new FileReader();
    reader.onload = function (e) {
        let url = e.target.result;

        // 保存到 localStorage
        localStorage.setItem("nie_avatar_ai", url);

        alert("AI 头像已更新！");
    };
    reader.readAsDataURL(file);
}
            
</script>
</body>
</html>
